<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><link href=https://gmpg.org/xfn/11 rel=profile><meta http-equiv=x-ua-compatible content="chrome=1"><meta charset=utf-8><meta name=robots content="index,follow"><meta name=apple-mobile-web-app-title content="Aashish Koirala"><meta name=application-name content="Aashish Koirala"><meta name=msapplication-TileColor content="#00aba9"><meta name=theme-color content="#ffffff"><meta charset=utf-8><meta name=generator content="Hugo 0.107.0"><meta name=viewport content="width=device-width,initial-scale=1"><title>Writing Your Own LINQ Provider- Part 3 &#183; Aashish Koirala</title><meta name=description content><link type=text/css rel=stylesheet href=https://aashishkoirala.com/css/print.css media=print><link type=text/css rel=stylesheet href=https://aashishkoirala.com/css/poole.css><link type=text/css rel=stylesheet href=https://aashishkoirala.com/css/syntax.css><link type=text/css rel=stylesheet href=https://aashishkoirala.com/css/hyde.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://aashishkoirala.com/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=https://aashishkoirala.com/apple-touch-icon.png><link rel="shortcut icon" href=https://aashishkoirala.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://aashishkoirala.com/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://aashishkoirala.com/favicon-16x16.png><link rel=manifest href=https://aashishkoirala.com/site.webmanifest><link rel=mask-icon href=https://aashishkoirala.com/favicon-safari-pinned-tab.svg color=#5bbad5><meta property="og:title" content="Writing Your Own LINQ Provider- Part 3"><meta property="og:description" content="This is the third in a short series of posts on writing your own LINQ provider. A quick outline of the series:
A primer Provider basics A simple, pointless solution (this post) A tiny ORM of our own A simple, pointless solution In the previous post, we took a look at what happens when you call LINQ methods on IQueryable<T>, and how you can use that to build your own provider."><meta property="og:type" content="article"><meta property="og:url" content="https://aashishkoirala.com/blog/tech/writing-your-own-linq-provider-part-3/"><meta property="og:image" content="https://aashishkoirala.com/logo.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2014-03-15T00:00:00+00:00"><meta property="article:modified_time" content="2014-03-15T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://aashishkoirala.com/logo.png"><meta name=twitter:title content="Writing Your Own LINQ Provider- Part 3"><meta name=twitter:description content="This is the third in a short series of posts on writing your own LINQ provider. A quick outline of the series:
A primer Provider basics A simple, pointless solution (this post) A tiny ORM of our own A simple, pointless solution In the previous post, we took a look at what happens when you call LINQ methods on IQueryable<T>, and how you can use that to build your own provider."></head><body class=theme-base-0d><aside class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://aashishkoirala.com/><img src=https://aashishkoirala.com/logo.png alt="Aashish Koirala Software Developer. Overthinker."><h1>aashish<b>koirala</b></h1></a><p class=lead>Software Developer. Overthinker.</p></div><nav><ul class=sidebar-nav><li><a href=https://aashishkoirala.com/>Home</a></li><li><a rel=me href=/about>About Me</a></li><li><a rel=me href=https://github.com/aashishkoirala/>Github</a></li><li><a rel=me href=https://twitter.com/aashishkoirala/>Twitter</a></li><li><a rel=me href=https://hachyderm.io/@aashishkoirala>Mastodon</a></li><li><a rel=me href=https://www.linkedin.com/in/aashishkoirala/>LinkedIn</a></li><li><a rel=me href=/blog/tech>Blog Posts - Tech</a></li><li><a rel=me href=/blog/nontech>Blog Posts - Non-Tech</a></li><li><a rel=me href=/index.xml>Subscribe (RSS)</a></li></ul></nav><p>&copy; 2022. All rights reserved.</p></div></aside><main class="content container"><div class=post><h1>Writing Your Own LINQ Provider- Part 3</h1><time datetime=2014-03-15T00:00:00Z class=post-date>Sat, Mar 15, 2014</time><p>This is the third in a short series of posts on writing your own LINQ provider. A quick outline of the series:</p><ol><li><a href=https://aashishkoirala.com/blog/tech/writing-your-own-linq-provider-part-1/>A primer</a></li><li><a href=https://aashishkoirala.com/blog/tech/writing-your-own-linq-provider-part-2/>Provider basics</a></li><li><strong>A simple, pointless solution</strong> (<em>this post</em>)</li><li><a href=https://aashishkoirala.com/blog/tech/writing-your-own-linq-provider-part-4/>A tiny ORM of our own</a></li></ol><hr><h3 id=a-simple-pointless-solution>A simple, pointless solution</h3><p>In the <a href=https://aashishkoirala.com/blog/tech/writing-your-own-linq-provider-part-2/>previous post</a>, we took a look at what happens when you call LINQ methods on <code>IQueryable&lt;T></code>, and how you can use that to build your own provider. We take that a step further this time by building an actual provider - albeit a somewhat pointless one, in that it adds LINQ support to something that doesn&rsquo;t really need it. The point, though, is to keep it simple and try to understand how the process works.</p><p>The best way to understand is to take a look at the source code first:</p><ul><li><a href=https://github.com/aashishkoirala/snippets/tree/master/src/NextProviderLinqProvider><strong>Click here for the source code for our solution</strong></a></li></ul><p>Now, a quick summary of what this is.</p><p>We have an interface, <code>INextProvider</code>. It has one method, <code>GetNext</code> that is supposed to get the next one in a sequence of items. An example implementation that uses a simple array as the underlying store is also included. Once you have an instance of <code>INextProvider&lt;T></code>, say, called <code>nextProvider</code>, you can then extract an <code>IQueryable&lt;T></code> out of it with this call:</p><pre><code>var query = nextProvider.AsQueryable();
</code></pre><p>You can then use standard LINQ on top of it. Now, I know what you&rsquo;re thinking: this <code>INextProvider</code> seems uncomfortably similar to <code>IEnumerator</code> - why would we need a query provider for this? We don&rsquo;t, hence the &ldquo;pointless&rdquo; part, but again - the idea is to examine how building a provider works.</p><p>The entry point is <code>NextProviderQueryable</code> which implements <code>IQueryable&lt;T></code> and uses <code>NextProviderQueryProvider</code> as its <code>Provider</code> and returns a <code>NextProviderEnumerator</code> from its <code>GetEnumerator()</code> call. This means that whenever one of the LINQ methods are called on an instance of <code>NextProviderQueryable</code>, one of the following happens:</p><ul><li><p>If the method is something that creates another queryable out of the existing one (e.g. <code>Where</code>, <code>Select</code>, <code>SelectMany</code>, <code>Cast</code>, etc.), <code>NextProviderQueryProvider.CreateQuery()</code> is called. That, in turn, creates a new instance of <code>NextProviderQueryable</code>, but with the <code>Expression</code> set to what has been passed in. Thus, every call to <code>CreateQuery</code> ends up creating a new queryable with the <code>Expression</code> property representing the complete call.</p></li><li><p>If the method is something that enumerates a queryable (e.g. <code>ToList</code>, <code>ToArray</code>, etc. or a <code>foreach</code> loop), the <code>GetEnumerator()</code> method is called and enumeration starts. This means that <code>NextProviderEnumerator</code> takes place. This object is initialized with the current value of <code>Expression</code> as of the time of enumeration, thus it has complete information to parse it, figure out what needs to be done, and then do it using the <code>INextProvider</code> that it is assigned. The class <code>ExpressionParser</code> is used to convert the expression into a series of &ldquo;nodes&rdquo; that act on each item in the underlying <code>INextProvider</code> and do the appropriate thing based on what it is (e.g. if it&rsquo;s a <code>WhereNode</code>, it will have a predicate that it will run on each item).</p></li><li><p>If the method is something that returns a scalar (e.g. <code>Any</code>, <code>All</code>, <code>First</code>, etc.), <code>NextProviderQueryProvider.Execute</code> is called. In our case, we simply pass control to <code>NextProviderEnumerator</code> to enumerate as mentioned in the previous point, and then perform the appropriate action. We do this by getting an <code>IEnumerable&lt;T></code> that uses <code>NextProviderEnumerator</code> as its enumerator (and that is the <code>NextProviderEnumerable</code> class), and then calling the appropriate <code>IEnumerable</code> version of the <code>IQueryable</code> method that has been called. All of this is handled by the <code>ExpressionExecutor</code> class.</p></li></ul><p>As of now, only the following methods are supported: <code>All</code>, <code>Any</code>, <code>Cast</code>, <code>Count</code>, <code>Distinct</code>, <code>ElementAt</code>, <code>ElementAtOrDefault</code>, <code>First</code>, <code>FirstOrDefault</code>, <code>Last</code>, <code>LastOrDefault</code>, <code>LongCount</code>, <code>OfType</code>, <code>Select</code>, <code>SelectMany</code>, <code>Single</code>, <code>SingleOrDefault</code>, <code>Skip</code>, <code>Take</code> and <code>Where</code>. If you try to use any other methods, you will get an exception. Even within these methods, if you try to use a variant that is not supported, you will get an exception.</p><p>Next time, we&rsquo;ll try our hands at a more real world implementation, i.e. a tiny, tiny ORM.</p><div style=font-size:smaller><br><br>Tags:
<a href=https://aashishkoirala.com/tags/csharp/>csharp</a> <a href=https://aashishkoirala.com/tags/dotnet/>dotnet</a> <a href=https://aashishkoirala.com/tags/linq/>linq</a><br>Previous:
<a href=https://aashishkoirala.com/blog/tech/writing-your-own-linq-provider-part-2/>Writing Your Own LINQ Provider- Part 2</a><br>Next:
<a href=https://aashishkoirala.com/blog/tech/writing-your-own-linq-provider-part-4/>Writing Your Own LINQ Provider- Part 4</a></div></div><h2>Comments</h2><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//aashishkoirala.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></main><script async src="https://www.googletagmanager.com/gtag/js?id=G-1VD1W7LBR1"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-1VD1W7LBR1",{anonymize_ip:!1})}</script></body></html>