<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><link href=https://gmpg.org/xfn/11 rel=profile><meta http-equiv=x-ua-compatible content="chrome=1"><meta charset=utf-8><meta name=robots content="index,follow"><meta name=apple-mobile-web-app-title content="Aashish Koirala"><meta name=application-name content="Aashish Koirala"><meta name=msapplication-TileColor content="#00aba9"><meta name=theme-color content="#ffffff"><meta charset=utf-8><meta name=generator content="Hugo 0.107.0"><meta name=viewport content="width=device-width,initial-scale=1"><title>Reader-Writer Locking with Async-Await &#183; Aashish Koirala</title><meta name=description content><link type=text/css rel=stylesheet href=https://aashishkoirala.com/css/print.css media=print><link type=text/css rel=stylesheet href=https://aashishkoirala.com/css/poole.css><link type=text/css rel=stylesheet href=https://aashishkoirala.com/css/syntax.css><link type=text/css rel=stylesheet href=https://aashishkoirala.com/css/hyde.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://aashishkoirala.com/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=https://aashishkoirala.com/apple-touch-icon.png><link rel="shortcut icon" href=https://aashishkoirala.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://aashishkoirala.com/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://aashishkoirala.com/favicon-16x16.png><link rel=manifest href=https://aashishkoirala.com/site.webmanifest><link rel=mask-icon href=https://aashishkoirala.com/favicon-safari-pinned-tab.svg color=#5bbad5><meta property="og:title" content="Reader-Writer Locking with Async-Await"><meta property="og:description" content="Consider this another pitfall warning. If you are a frequent user of reader/writer locking (via the ReaderWriterLockSlim class) like I am, you will undoubtedly run into this situation. As more and more code we write these days are asynchronous with the use of async/await, it is easy to end up in the following situation (an oversimplification, but just imagine write locks in there as well):
async Task MyMethod() { ... myReaderWriterLockSlim."><meta property="og:type" content="article"><meta property="og:url" content="https://aashishkoirala.com/blog/tech/reader-writer-locking-with-async-await/"><meta property="og:image" content="https://aashishkoirala.com/logo.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2017-12-20T00:00:00+00:00"><meta property="article:modified_time" content="2017-12-20T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://aashishkoirala.com/logo.png"><meta name=twitter:title content="Reader-Writer Locking with Async-Await"><meta name=twitter:description content="Consider this another pitfall warning. If you are a frequent user of reader/writer locking (via the ReaderWriterLockSlim class) like I am, you will undoubtedly run into this situation. As more and more code we write these days are asynchronous with the use of async/await, it is easy to end up in the following situation (an oversimplification, but just imagine write locks in there as well):
async Task MyMethod() { ... myReaderWriterLockSlim."></head><body class=theme-base-0d><aside class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://aashishkoirala.com/><img src=https://aashishkoirala.com/logo.png alt="Aashish Koirala Software Developer. Overthinker."><h1>aashish<b>koirala</b></h1></a><p class=lead>Software Developer. Overthinker.</p></div><nav><ul class=sidebar-nav><li><a href=https://aashishkoirala.com/>Home</a></li><li><a rel=me href=/about>About Me</a></li><li><a rel=me href=https://github.com/aashishkoirala/>Github</a></li><li><a rel=me href=https://twitter.com/aashishkoirala/>Twitter</a></li><li><a rel=me href=https://hachyderm.io/@aashishkoirala>Mastodon</a></li><li><a rel=me href=https://www.linkedin.com/in/aashishkoirala/>LinkedIn</a></li><li><a rel=me href=/blog/tech>Blog Posts - Tech</a></li><li><a rel=me href=/blog/nontech>Blog Posts - Non-Tech</a></li><li><a rel=me href=/index.xml>Subscribe (RSS)</a></li></ul></nav><p>&copy; 2022. All rights reserved.</p></div></aside><main class="content container"><div class=post><h1>Reader-Writer Locking with Async-Await</h1><time datetime=2017-12-20T00:00:00Z class=post-date>Wed, Dec 20, 2017</time><p>Consider this another pitfall warning. If you are a frequent user of <a href=https://aashishkoirala.com/blog/tech/reader-writer-locking-in-dotnet/>reader/writer locking</a> (via the <a href="https://docs.microsoft.com/en-us/dotnet/api/system.threading.readerwriterlockslim?view=netframework-4.7.2"><code>ReaderWriterLockSlim</code></a> class) like I am, you will undoubtedly run into this situation. As more and more code we write these days are asynchronous with the use of <code>async/await</code>, it is easy to end up in the following situation (an oversimplification, but just imagine write locks in there as well):</p><pre><code>async Task MyMethod()
{
	...
	myReaderWriterLockSlim.EnterReadLock();
	var thing = await ReadThingAsync();
	... 
	myReaderWriterLockSlim.ExitReadLock(); // This guy will choke.
}
</code></pre><p>This, of course, will not work. This is because reader/writer locks, at least the implementation in .NET, are <em>thread-affine</em>. This means the very same thread that acquired a lock must be the one to release it. As soon as you hit an <code>await</code>, you have dispatched the rest of the behavior to some other thread. So this cannot work.</p><p>This explains why other thread-synchronization classes such as <code>SemaphoreSlim</code> are not async/await savvy with methods like <code>WaitAsync</code> but not <code>ReaderWriterLockSlim</code>.</p><p>So, what are our options?</p><ol><li>Carefully write our code such that whatever happens between reader/writer locks is always synchronous.</li><li>Relax some of the rules around reader/writer locking that requires it to be thread-affine and roll your own.</li><li>Look for an already existing, widely adopted, mature library that handles this very scenario.</li></ol><p>In the spirit of Option 3, <a href=https://blog.stephencleary.com/>Stephen Cleary</a> has an <a href=https://github.com/StephenCleary/AsyncEx>AsyncEx</a> library that includes this functionality and many others geared towards working efficiently with <code>async/await</code>. If that is too heavy-handed, may I suggest <a href=https://blogs.msdn.microsoft.com/pfxteam/2012/02/12/building-async-coordination-primitives-part-7-asyncreaderwriterlock/>this post</a> by <a href=https://github.com/stephentoub>Stephen Toub</a> that lays out a basic implementation that you can build upon?</p><div style=font-size:smaller><br><br>Tags:
<a href=https://aashishkoirala.com/tags/csharp/>csharp</a> <a href=https://aashishkoirala.com/tags/dotnet/>dotnet</a> <a href=https://aashishkoirala.com/tags/threads/>threads</a> <a href=https://aashishkoirala.com/tags/async/>async</a> <a href=https://aashishkoirala.com/tags/await/>await</a><br>Previous:
<a href=https://aashishkoirala.com/blog/tech/listor-showcasing-react-and-dotnet-core/>Listor- Showcasing React and .NET Core</a><br>Next:
<a href=https://aashishkoirala.com/blog/tech/on-service-fabric-kubernetes-and-docker/>On Service Fabric, Kubernetes and Docker</a></div></div><h2>Comments</h2><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//aashishkoirala.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></main><script async src="https://www.googletagmanager.com/gtag/js?id=G-1VD1W7LBR1"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-1VD1W7LBR1",{anonymize_ip:!1})}</script></body></html>