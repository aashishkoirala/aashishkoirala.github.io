<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><link href=https://gmpg.org/xfn/11 rel=profile><meta http-equiv=x-ua-compatible content="chrome=1"><meta charset=utf-8><meta name=robots content="index,follow"><meta name=apple-mobile-web-app-title content="Aashish Koirala"><meta name=application-name content="Aashish Koirala"><meta name=msapplication-TileColor content="#00aba9"><meta name=theme-color content="#ffffff"><meta charset=utf-8><meta name=generator content="Hugo 0.105.0"><meta name=viewport content="width=device-width,initial-scale=1"><title>Writing Your Own LINQ Provider- Part 4 &#183; Aashish Koirala</title><meta name=description content><link type=text/css rel=stylesheet href=https://aashishkoirala.com/css/print.css media=print><link type=text/css rel=stylesheet href=https://aashishkoirala.com/css/poole.css><link type=text/css rel=stylesheet href=https://aashishkoirala.com/css/syntax.css><link type=text/css rel=stylesheet href=https://aashishkoirala.com/css/hyde.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://aashishkoirala.com/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=https://aashishkoirala.com/apple-touch-icon.png><link rel="shortcut icon" href=https://aashishkoirala.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://aashishkoirala.com/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://aashishkoirala.com/favicon-16x16.png><link rel=manifest href=https://aashishkoirala.com/site.webmanifest><link rel=mask-icon href=https://aashishkoirala.com/favicon-safari-pinned-tab.svg color=#5bbad5><meta property="og:title" content="Writing Your Own LINQ Provider- Part 4"><meta property="og:description" content="This is the last in a short series of posts on writing your own LINQ provider. A quick outline of the series:
A primer Provider basics A simple, pointless solution A tiny ORM of our own (this post) A tiny ORM of our own In the previous post, we took a look at a simple, albeit pointless example of a LINQ provider. We wrap the series up this time by looking at something a little less pointless - a LINQ-based ORM, albeit a very rudimentary one."><meta property="og:type" content="article"><meta property="og:url" content="https://aashishkoirala.com/blog/tech/writing-your-own-linq-provider-part-4/"><meta property="og:image" content="https://aashishkoirala.com/logo.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2014-03-16T00:00:00+00:00"><meta property="article:modified_time" content="2014-03-16T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://aashishkoirala.com/logo.png"><meta name=twitter:title content="Writing Your Own LINQ Provider- Part 4"><meta name=twitter:description content="This is the last in a short series of posts on writing your own LINQ provider. A quick outline of the series:
A primer Provider basics A simple, pointless solution A tiny ORM of our own (this post) A tiny ORM of our own In the previous post, we took a look at a simple, albeit pointless example of a LINQ provider. We wrap the series up this time by looking at something a little less pointless - a LINQ-based ORM, albeit a very rudimentary one."></head><body class=theme-base-0d><aside class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://aashishkoirala.com/><img src=https://aashishkoirala.com/logo.png alt="Aashish Koirala Software Developer. Overthinker."><h1>aashish<b>koirala</b></h1></a><p class=lead>Software Developer. Overthinker.</p></div><nav><ul class=sidebar-nav><li><a href=https://aashishkoirala.com/>Home</a></li><li><a href=/about>About Me</a></li><li><a href=https://github.com/aashishkoirala/>Github</a></li><li><a href=https://twitter.com/aashishkoirala/>Twitter</a></li><li><a href=https://www.linkedin.com/in/aashishkoirala/>LinkedIn</a></li><li><a href=/blog/tech>Blog Posts - Tech</a></li><li><a href=/blog/nontech>Blog Posts - Non-Tech</a></li><li><a href=/index.xml>Subscribe (RSS)</a></li></ul></nav><p>&copy; 2022. All rights reserved.</p></div></aside><main class="content container"><div class=post><h1>Writing Your Own LINQ Provider- Part 4</h1><time datetime=2014-03-16T00:00:00Z class=post-date>Sun, Mar 16, 2014</time><p>This is the last in a short series of posts on writing your own LINQ provider. A quick outline of the series:</p><ol><li><a href=https://aashishkoirala.com/blog/tech/writing-your-own-linq-provider-part-1/>A primer</a></li><li><a href=https://aashishkoirala.com/blog/tech/writing-your-own-linq-provider-part-2/>Provider basics</a></li><li><a href=https://aashishkoirala.com/blog/tech/writing-your-own-linq-provider-part-3/>A simple, pointless solution</a></li><li><strong>A tiny ORM of our own</strong> (<em>this post</em>)</li></ol><hr><h3 id=a-tiny-orm-of-our-own>A tiny ORM of our own</h3><p>In the <a href=https://aashishkoirala.com/blog/tech/writing-your-own-linq-provider-part-3/>previous post</a>, we took a look at a simple, albeit pointless example of a LINQ provider. We wrap the series up this time by looking at something a little less pointless - a LINQ-based ORM, albeit a very rudimentary one. As with the previous one, it helps to take a look at the source code first:</p><ul><li><a href=https://github.com/aashishkoirala/snippets/tree/master/src/TinyOrm><strong>Click here for the source code for our tiny ORM</strong></a></li></ul><p>This is a very simple example implementation and has its limitations. It only works with SQL Server. It only supports reads. It only supports these methods:</p><ul><li>Any</li><li>Count</li><li>First</li><li>FirstOrDefault</li><li>Select</li><li>Single</li><li>SingleOrDefault</li><li>Where</li><li>OrderBy</li><li>OrderByDescending</li><li>ThenBy</li><li>ThenByDescending</li></ul><p>There are a few more limitations, but again the point is not to redo NHibernate or Entity Framework. There is also a simple fluent mapping interface that you can use as so:</p><pre><code>Mapper.For&lt;MyThing&gt;(&quot;my_thing_tbl&quot;)
    .Member(x =&gt; x.Id, &quot;id&quot;)
    .Member(x =&gt; x.Name &quot;thing_name&quot;)
    .Member(x =&gt; x.Date &quot;thing_date&quot;);
</code></pre><p>Once you&rsquo;ve got your mappings in place, it is up to you to create the DB connection. Once you&rsquo;ve done that, you can create an <code>IQueryable&lt;T></code> out of a <code>SqlConnection</code> instance and then do LINQ on top of it.</p><pre><code>using (var conn = new SqlConnection(&quot;...&quot;))
{
    conn.Profile(Console.WriteLine); // Write generated query to console.
    conn.Open();

    var query = conn.Query&lt;MyThing&gt;();

    var things = query
        .Where(x =&gt; x.Id &lt; 1000)
        .OrderBy(x =&gt; x.Name)
        .Select(x =&gt; new {x.Id, x.Name, x.Date})
        .ToArray();
}
</code></pre><p>Or, using the &ldquo;other&rdquo; syntax:</p><pre><code>var things = (from item in query
				where item.Id &lt; 1000
				orderby item.Name
				select new { item.Id, item.Name, item.Date }).ToArray();
</code></pre><p>If you recall <strong>Step 2</strong> from <a href=https://aashishkoirala.com/blog/tech/writing-your-own-linq-provider-part-2/>provider basics</a>, there were two options. The <a href=https://aashishkoirala.com/blog/tech/writing-your-own-linq-provider-part-3/>last solution</a> used Option 1, i.e. there is one queryable that just builds up the expression and the enumerator does the parsing. For this one, we&rsquo;re using Option 2, where we have a separate implementation of <code>IQueryable&lt;T></code> for each type of query operation to support.</p><p>When you first obtain a queryable, you get an instance of <code>TableQueryable</code> (which is descended from <code>SqlQueryable</code>) corresponding to the table that the type is mapped to. Each call on top of it then wraps the queryable in another descedant of <code>SqlQueryable</code> (e.g. <code>WhereQueryable</code> for <code>Where</code> operations, and so on). This logic is in <code>SqlQueryProvider</code>. Similarly, for executable methods, the appropriate type of <code>ExecutableBase</code> is created and called. Beyond this, the actual query creation logic is implemented in the individual queryables and executables defined within the <code>Constructs</code> namespace.</p><p>The queryables and executables work with classes within the <code>QueryModel</code> namespace that represent parts of a SQL query. Based on what operation they stand for, they convert an <code>Expression</code> into a <code>Query</code>, which can then be converted into a SQL string. Each queryable implements a <code>Parse</code> method that does this, and as part of doing this, it parses the queryable it wraps and then works on top of the <code>Query</code> object returned by the inner <code>Parse</code>, and so on until the top-most enumerable gives you the final query. The innermost or leaf queryable is always <code>TableQueryable</code> which simply adds the name of the source table to the query model.</p><p>LINQ is undoubtedly awesome, but knowing how it works gives you new appreciation for just how powerful it can be. Man, I love LINQ.</p><div style=font-size:smaller><br><br>Tags:
<a href=https://aashishkoirala.com/tags/csharp/>csharp</a> <a href=https://aashishkoirala.com/tags/dotnet/>dotnet</a> <a href=https://aashishkoirala.com/tags/linq/>linq</a><br>Previous:
<a href=https://aashishkoirala.com/blog/tech/writing-your-own-linq-provider-part-3/>Writing Your Own LINQ Provider- Part 3</a><br>Next:
<a href=https://aashishkoirala.com/blog/tech/bootstrap-modal-with-angularjs/>Bootstrap Modal With AngularJS</a></div></div><h2>Comments</h2><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//aashishkoirala.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></main><script async src="https://www.googletagmanager.com/gtag/js?id=G-1VD1W7LBR1"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-1VD1W7LBR1",{anonymize_ip:!1})}</script></body></html>